# Periphery

Peripheral contracts provide helper utilities and integrations for the Generic protocol, including automated deposit/withdraw routing and DEX swap integrations.

## Components

### Depositor

Automated deposit routing that:
- Finds best vault for asset
- Executes deposit transaction
- Returns share tokens

**Use Case:** Simplify user deposits without vault selection

[Learn more →](/protocol/periphery/depositor)

### Swapper

DEX integration for asset swaps:
- Uniswap V3 integration
- 1inch aggregator support
- Multi-hop routing

**Use Case:** Convert assets before deposit, execute rebalancing swaps

[Learn more →](/protocol/periphery/swapper)

## Architecture

```
┌─────────────┐
│   Users     │
└──────┬──────┘
       │
       ▼
┌─────────────┐      ┌──────────────┐
│  Depositor  │─────▶│  Controller  │
└─────────────┘      └──────────────┘
       │                     │
       ▼                     ▼
┌─────────────┐      ┌──────────────┐
│   Swapper   │      │    Vaults    │
└─────────────┘      └──────────────┘
```

## Quick Start

### Simple Deposit

```solidity
// User wants to deposit 1000 USDC
depositor.deposit(USDC, 1000e6, user);
// Returns GenericUnit shares
```

### Swap and Deposit

```solidity
// User has ETH, wants GUSD
swapper.swapExactInput(
    ETH,
    USDC,
    1e18,  // 1 ETH
    minUSDC,
    swapData
);

// Then deposit USDC
depositor.deposit(USDC, usdcReceived, user);
```

## Integration Examples

### Frontend Integration

```typescript
// Deposit helper
async function depositToGeneric(asset: string, amount: bigint) {
  // Approve depositor
  await token.approve(depositorAddress, amount);

  // Execute deposit
  const tx = await depositor.deposit(asset, amount, userAddress);
  const receipt = await tx.wait();

  // Get shares minted
  const sharesEvent = receipt.events.find(e => e.event === 'SharesMinted');
  return sharesEvent.args.shares;
}
```

### Backend Bot

```typescript
// Rebalancing bot
async function rebalanceVault(from: Vault, to: Vault, amount: bigint) {
  // Get assets
  const fromAsset = await from.asset();
  const toAsset = await to.asset();

  // Withdraw from source vault
  await controller.withdrawFromVault(from, amount);

  // Swap if needed
  if (fromAsset !== toAsset) {
    await swapper.swap(fromAsset, toAsset, amount, minOut, swapData);
  }

  // Deposit to target vault
  await controller.depositToVault(to, amountOut);
}
```

## Gas Optimization

### Batching

Depositor supports batched operations:

```solidity
function depositBatch(
    address[] calldata assets,
    uint256[] calldata amounts,
    address recipient
) external returns (uint256[] memory shares)
```

### Multicall

```solidity
// Execute multiple operations in one transaction
bytes[] memory calls = new bytes[](3);
calls[0] = abi.encodeCall(depositor.deposit, (USDC, 1000e6, user));
calls[1] = abi.encodeCall(depositor.deposit, (USDT, 500e6, user));
calls[2] = abi.encodeCall(depositor.deposit, (USDS, 2000e18, user));

depositor.multicall(calls);
```

## Security

### No Asset Custody

Periphery contracts never hold user funds:
- Deposits execute atomically
- Swaps route directly to destination
- No approval required for contract

### Upgradeable

Periphery can be upgraded without affecting core protocol:

```solidity
// Deploy new depositor
Depositor newDepositor = new Depositor(controller);

// Update reference
registry.setDepositor(address(newDepositor));

// Old depositor still works but deprecated
```

## Best Practices

### For Users

1. **Check slippage** - Set reasonable minimums
2. **Approve exact amount** - Don't approve unlimited
3. **Verify destination** - Confirm recipient address
4. **Monitor gas** - Use gas estimates

### For Developers

1. **Validate inputs** - Check addresses and amounts
2. **Handle failures** - Wrap in try-catch
3. **Test thoroughly** - Cover edge cases
4. **Document integration** - Clear API docs

## Events

```solidity
// Depositor
event DepositExecuted(
    address indexed user,
    address indexed asset,
    uint256 amount,
    uint256 shares
);

// Swapper
event SwapExecuted(
    address indexed tokenIn,
    address indexed tokenOut,
    uint256 amountIn,
    uint256 amountOut
);
```

## Next Steps

- **[Depositor](/protocol/periphery/depositor)** - Automated deposit routing
- **[Swapper](/protocol/periphery/swapper)** - DEX integrations
- **[Controller](/protocol/controller)** - Core protocol logic
